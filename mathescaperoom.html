<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pop Star Tour Math Escape â€” Year 9 | Aotearoa</title>
  <style>
    :root {
      --bg: #fdf2f8;
      --card: #ffffff;
      --accent: #ec4899;
      --accent-dark: #be185d;
      --success: #34d399;
      --danger: #f87171;
      --muted: #6b7280;
      --text: #1f2937;
      --highlight: #facc15;
      --max-width: 1000px;
      --pad: 1.5rem;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(180deg, #fdf2f8 0%, #fce7f3 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--pad);
      font-size: clamp(16px, 2.5vw, 18px);
    }
    .wrap { width: 100%; max-width: var(--max-width); margin: 0 auto; }

    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .brand { display: flex; gap: 0.8rem; align-items: center; }
    .logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo svg { width: 40px; height: 40px; fill: #ffffff; }
    h1 {
      font-size: clamp(1.5rem, 3vw, 1.8rem);
      margin: 0;
      color: var(--text);
    }
    p.lead {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.9rem, 2vw, 1rem);
    }

    .card {
      background: var(--card);
      padding: var(--pad);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .topbar {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .status { display: flex; gap: 0.8rem; align-items: center; }
    .chip {
      background: #fce7f3;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: clamp(0.85rem, 2vw, 0.95rem);
      color: var(--text);
      border: 1px solid var(--accent);
    }
    .timer { font-size: clamp(1rem, 2.5vw, 1.1rem); }

    .room { display: none; }
    .room.active { display: block; }

    .quiz {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 600px) { .quiz { grid-template-columns: 1fr 300px; } }
    @media (min-width: 900px) { .quiz { grid-template-columns: 1fr 350px; } }

    .puzzle {
      padding: 1.25rem;
      border-radius: 12px;
      background: #fff1f8;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--muted);
      font-size: clamp(0.85rem, 2vw, 0.95rem);
    }
    input[type=text], input[type=number] {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: #ffffff;
      color: var(--text);
      font-size: clamp(0.9rem, 2vw, 1rem);
    }
    button {
      cursor: pointer;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 0;
      background: var(--accent);
      color: #ffffff;
      font-weight: 600;
      font-size: clamp(0.9rem, 2vw, 1rem);
      transition: background 0.2s;
    }
    button:hover { background: var(--accent-dark); }
    .muted { color: var(--muted); }

    .hint {
      background: #fce7f3;
      padding: 0.75rem;
      border-radius: 8px;
      margin-top: 0.75rem;
      font-size: clamp(0.85rem, 2vw, 0.9rem);
      border: 1px solid var(--accent);
    }
    .footer {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
    }

    .solved {
      background: #ecfdf5;
      border-left: 4px solid var(--success);
    }
    .locked {
      opacity: 0.85;
      background: #f3f4f6;
    }

    .clue {
      font-weight: 700;
      font-size: clamp(1.25rem, 2.5vw, 1.4rem);
      color: var(--text);
    }

    .progress {
      height: 14px;
      background: #fce7f3;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress > i {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #a855f7);
      width: 0%;
      transition: width 0.3s ease;
    }

    .small { font-size: clamp(0.8rem, 1.8vw, 0.85rem); }

    :focus {
      outline: 3px solid rgba(236, 72, 153, 0.3);
      outline-offset: 2px;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--pad);
      background: rgba(0, 0, 0, 0.5);
    }
    .modal .card {
      max-width: 700px;
      text-align: center;
    }

    @media (max-width: 600px) {
      .logo { width: 48px; height: 48px; }
      header { gap: 0.75rem; }
      h1 { font-size: clamp(1.25rem, 2.5vw, 1.5rem); }
      .card { padding: 1rem; }
      button { padding: 0.6rem 0.8rem; }
      input[type=text], input[type=number] { padding: 0.6rem; }
    }
    @media (min-width: 600px) and (max-width: 900px) {
      .wrap { max-width: 90%; }
      .quiz { grid-template-columns: 1fr 280px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24">
            <path d="M12 2a1 1 0 0 1 .894.553L20 14h-4v8H8v-8H4L11.106 2.553A1 1 0 0 1 12 2zm0 2.236L6.618 12H10v8h4v-8h3.382L12 4.236z"/>
          </svg>
        </div>
        <div>
          <h1>Pop Star Tour Math Escape â€” Year 9</h1>
          <p class="lead">Aotearoa NZ puzzles: algebra, fractions, geometry & patterns. Unlock the concert stages!</p>
        </div>
      </div>
      <div style="margin-left: auto; text-align: right;" class="small muted">Teacher: editable hints & answers</div>
    </header>

    <div class="card">
      <div class="topbar">
        <div class="status">
          <div class="chip">Stage <span id="roomIndex">1</span>/4</div>
          <div class="chip timer">ðŸŽ¤ <span id="timer">10:00</span></div>
          <div class="chip">Points: <span id="points">0</span></div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button id="pauseBtn" class="small">Pause</button>
          <button id="saveBtn" class="small">Save</button>
          <button id="resetBtn" class="small">Restart</button>
        </div>
      </div>

      <div class="progress" aria-hidden="true"><i id="progressFill"></i></div>

      <!-- Stages -->
      <section id="room1" class="room active" aria-labelledby="r1">
        <h2 id="r1" class="clue">Stage 1 â€” Auckland Arena Pass</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>Solve for the stage pass code: <strong>2x + 3 = 11</strong>. What is <strong>x</strong>?</p>
            <label for="r1ans">Enter the value of x</label>
            <input id="r1ans" type="number" inputmode="numeric" placeholder="x" aria-label="Stage 1 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r1check">Submit</button>
              <button id="r1hint" class="small">Hint</button>
            </div>
            <div id="r1msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Isolate x by subtracting, then dividing.</p>
            <div class="hint small" id="r1hintbox" style="display: none;">Subtract 3 from both sides, then divide by 2.</div>
          </aside>
        </div>
      </section>

      <section id="room2" class="room" aria-labelledby="r2">
        <h2 id="r2" class="clue">Stage 2 â€” Wellington Stage Setup</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>Add fractions to set up the stage: <strong>1/4 + 1/3</strong>. Enter as a fraction (e.g., 2/3).</p>
            <label for="r2ans">Enter the fraction</label>
            <input id="r2ans" type="text" placeholder="a/b" aria-label="Stage 2 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r2check">Submit</button>
              <button id="r2hint" class="small">Hint</button>
            </div>
            <div id="r2msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Use a common denominator to add fractions.</p>
            <div class="hint small" id="r2hintbox" style="display: none;">The least common denominator for 4 and 3 is 12.</div>
          </aside>
        </div>
      </section>

      <section id="room3" class="room" aria-labelledby="r3">
        <h2 id="r3" class="clue">Stage 3 â€” Kiwi Pop Fest</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>The stage is a rectangle, 5m wide and 8m long. What is the perimeter in meters?</p>
            <label for="r3ans">Enter the perimeter in meters</label>
            <input id="r3ans" type="number" inputmode="numeric" aria-label="Stage 3 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r3check">Submit</button>
              <button id="r3hint" class="small">Hint</button>
            </div>
            <div id="r3msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Perimeter = 2 Ã— (width + length).</p>
            <div class="hint small" id="r3hintbox" style="display: none;">Add width and length, then multiply by 2.</div>
          </aside>
        </div>
      </section>

      <section id="room4" class="room" aria-labelledby="r4">
        <h2 id="r4" class="clue">Final Stage â€” Pop Star Finale</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>Find the next number in the sequence for the finale: <strong>2, 5, 8, 11, ?</strong>.</p>
            <label for="r4ans">Enter the next number</label>
            <input id="r4ans" type="number" inputmode="numeric" aria-label="Stage 4 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r4check">Submit</button>
              <button id="r4hint" class="small">Hint</button>
            </div>
            <div id="r4msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Look for a pattern in the sequence.</p>
            <div class="hint small" id="r4hintbox" style="display: none;">Each number increases by 3.</div>
          </aside>
        </div>
      </section>

      <div class="footer">
        <div class="muted small">Hints used: <span id="hintsUsed">0</span></div>
      </div>
    </div>
  </div>

  <template id="endModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="card">
        <h2>Rocked It! Tour Complete ðŸŽ‰</h2>
        <p class="muted">You scored <strong id="finalPoints"></strong> points and used <span id="finalHints"></span> hints.</p>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button id="closeEnd">Close</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    console.log("JavaScript is running! Initializing Pop Star Tour Math Escape...");

    document.addEventListener('DOMContentLoaded', () => {
      const rooms = [
        { id: 'room1', check: checkR1, hintText: 'Subtract 3 from both sides, then divide by 2.', points: 20 },
        { id: 'room2', check: checkR2, hintText: 'The least common denominator for 4 and 3 is 12.', points: 15 },
        { id: 'room3', check: checkR3, hintText: 'Add width and length, then multiply by 2.', points: 15 },
        { id: 'room4', check: checkR4, hintText: 'Each number increases by 3.', points: 25 },
      ];

      let index = Number(localStorage.getItem('er_index') || 0);
      let points = Number(localStorage.getItem('er_points') || 0);
      let hints = Number(localStorage.getItem('er_hints') || 0);
      let solved = JSON.parse(localStorage.getItem('er_solved') || '[]');
      let totalTime = Number(localStorage.getItem('er_time') || 10 * 60);
      let timerInterval = null;
      let isPaused = false;

      const roomIndexEl = document.getElementById('roomIndex');
      const pointsEl = document.getElementById('points');
      const hintsEl = document.getElementById('hintsUsed');
      const timerEl = document.getElementById('timer');
      const progressFill = document.getElementById('progressFill');
      const pauseBtn = document.getElementById('pauseBtn');

      try {
        solved = Array.isArray(solved) && solved.length ? solved : new Array(rooms.length).fill(false);
      } catch (e) {
        console.error('Error parsing solved state:', e);
        solved = new Array(rooms.length).fill(false);
      }
      if (index < 0 || index >= rooms.length || isNaN(index)) index = 0;

      updateUI();
      startTimer();

      pauseBtn.addEventListener('click', () => {
        console.log('Pause/Resume button clicked');
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
        if (isPaused) {
          clearInterval(timerInterval);
        } else {
          startTimer();
        }
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        console.log('Save button clicked');
        saveState();
        alert('Progress saved locally in your browser.');
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        console.log('Reset button clicked');
        if (!confirm('Restart the tour? This clears saved progress.')) return;
        localStorage.removeItem('er_index');
        localStorage.removeItem('er_points');
        localStorage.removeItem('er_solved');
        localStorage.removeItem('er_hints');
        localStorage.removeItem('er_time');
        location.reload();
      });

      rooms.forEach((r, i) => {
        const rid = r.id;
        const checkBtn = document.getElementById(rid + 'check');
        const hintBtn = document.getElementById(rid + 'hint');
        const hintBox = document.getElementById(rid + 'hintbox');
        if (!checkBtn || !hintBtn || !hintBox) {
          console.error(`Button or hint box missing for room ${rid}: checkBtn=${!!checkBtn}, hintBtn=${!!hintBtn}, hintBox=${!!hintBox}`);
          return;
        }
        checkBtn.addEventListener('click', () => {
          console.log(`Submit button clicked for ${rid}`);
          try {
            r.check();
          } catch (e) {
            console.error(`Error in check function for ${rid}:`, e);
          }
        });
        hintBtn.addEventListener('click', () => {
          console.log(`Hint button clicked for ${rid}`);
          hintBox.style.display = 'block';
          hints++;
          hintsEl.textContent = hints;
          localStorage.setItem('er_hints', hints);
        });
      });

      function checkR1() {
        const val = Number(document.getElementById('r1ans').value.trim());
        const msg = document.getElementById('r1msg');
        if (!Number.isFinite(val)) {
          msg.textContent = 'Enter a number.';
          msg.style.color = var(--danger);
          return;
        }
        // 2x + 3 = 11 â†’ 2x = 8 â†’ x = 4
        if (val === 4) {
          winRoom(0);
          msg.textContent = 'Correct â€” Auckland Arena unlocked!';
          msg.classList.remove('muted');
          msg.style.color = var(--success);
        } else {
          msg.textContent = 'Try subtracting 3 from both sides, then divide by 2.';
          msg.style.color = var(--danger);
        }
      }

      function checkR2() {
        const val = document.getElementById('r2ans').value.trim().replace(/\s+/g, '');
        const msg = document.getElementById('r2msg');
        if (!val.match(/^\d+\/\d+$/)) {
          msg.textContent = 'Enter a fraction like a/b (e.g., 2/3).';
          msg.style.color = var(--danger);
          return;
        }
        // 1/4 + 1/3 = 3/12 + 4/12 = 7/12
        if (val === '7/12' || val === '7 / 12') {
          winRoom(1);
          msg.textContent = 'Correct â€” Wellington Stage ready!';
          msg.classList.remove('muted');
          msg.style.color = var(--success);
        } else {
          msg.textContent = 'Use a common denominator (12) to add 1/4 + 1/3.';
          msg.style.color = var(--danger);
        }
      }

      function checkR3() {
        const val = Number(document.getElementById('r3ans').value.trim());
        const msg = document.getElementById('r3msg');
        if (!Number.isFinite(val)) {
          msg.textContent = 'Enter a number.';
          msg.style.color = var(--danger);
          return;
        }
        // Perimeter = 2 Ã— (5 + 8) = 2 Ã— 13 = 26
        if (val === 26) {
          winRoom(2);
          msg.textContent = 'Correct â€” Kiwi Pop Fest stage open!';
          msg.classList.remove('muted');
          msg.style.color = var(--success);
        } else {
          msg.textContent = 'Use perimeter = 2 Ã— (width + length).';
          msg.style.color = var(--danger);
        }
      }

      function checkR4() {
        const val = Number(document.getElementById('r4ans').value.trim());
        const msg = document.getElementById('r4msg');
        if (!Number.isFinite(val)) {
          msg.textContent = 'Enter a number.';
          msg.style.color = var(--danger);
          return;
        }
        // 2, 5, 8, 11 â†’ +3 â†’ 14
        if (val === 14) {
          winRoom(3);
          msg.textContent = 'Correct â€” Pop Star Finale unlocked!';
          msg.classList.remove('muted');
          msg.style.color = var(--success);
        } else {
          msg.textContent = 'Look for the pattern: each number increases by 3.';
          msg.style.color = var(--danger);
        }
      }

      function winRoom(i) {
        if (solved[i]) return;
        solved[i] = true;
        points += rooms[i].points;
        document.getElementById('points').textContent = points;
        localStorage.setItem('er_points', points);
        localStorage.setItem('er_solved', JSON.stringify(solved));
        const el = document.getElementById(rooms[i].id);
        el.classList.add('solved');
        const next = findNextUnsolved(i + 1);
        if (next !== null) {
          index = next;
          localStorage.setItem('er_index', index);
          updateUI();
        } else {
          showEnd();
        }
      }

      function findNextUnsolved(start) {
        for (let i = start; i < rooms.length; i++) {
          if (!solved[i]) return i;
        }
        return null;
      }

      function updateUI() {
        rooms.forEach((r, i) => {
          const el = document.getElementById(r.id);
          el.classList.toggle('active', i === index);
          el.classList.toggle('locked', !(!solved[i] || i === index));
        });
        roomIndexEl.textContent = Math.min(index + 1, rooms.length);
        pointsEl.textContent = points;
        hintsEl.textContent = hints;
        const solvedCount = solved.filter(Boolean).length;
        const pct = Math.round((solvedCount / rooms.length) * 100);
        progressFill.style.width = pct + '%';
      }

      function startTimer() {
        if (isPaused || totalTime <= 0) return;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
          totalTime--;
          localStorage.setItem('er_time', totalTime);
          if (totalTime <= 0) {
            clearInterval(timerInterval);
            onTimeUp();
          }
          updateTimerDisplay();
        }, 1000);
      }

      function updateTimerDisplay() {
        const mm = Math.floor(totalTime / 60);
        const ss = totalTime % 60;
        timerEl.textContent = `${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;
      }

      function onTimeUp() {
        isPaused = true;
        pauseBtn.textContent = 'Resume';
        alert('Timeâ€™s up! Your teacher can reset the timer or allow retries.');
      }

      function showEnd() {
        clearInterval(timerInterval);
        isPaused = true;
        pauseBtn.textContent = 'Resume';
        const tpl = document.getElementById('endModal');
        const clone = tpl.content.cloneNode(true);
        clone.querySelector('#finalPoints').textContent = points + ' pts';
        clone.querySelector('#finalHints').textContent = hints;
        document.body.appendChild(clone);
        document.getElementById('closeEnd').addEventListener('click', () => {
          document.querySelector('.modal').remove();
        });
      }

      function saveState() {
        localStorage.setItem('er_index', index);
        localStorage.setItem('er_points', points);
        localStorage.setItem('er_solved', JSON.stringify(solved));
        localStorage.setItem('er_hints', hints);
        localStorage.setItem('er_time', totalTime);
      }

      let pressTimer = null;
      const logo = document.querySelector('.logo');
      logo.addEventListener('mousedown', startPress);
      logo.addEventListener('touchstart', startPress);
      logo.addEventListener('mouseup', cancelPress);
      logo.addEventListener('mouseleave', cancelPress);
      logo.addEventListener('touchend', cancelPress);
      function startPress(e) {
        pressTimer = setTimeout(() => {
          const reveal = confirm('Teacher quick reveal? This will mark all stages solved.');
          if (reveal) {
            for (let i = 0; i < rooms.length; i++) solved[i] = true;
            points = rooms.reduce((s, r) => s + r.points, 0);
            saveState();
            updateUI();
            showEnd();
          }
        }, 900);
      }
      function cancelPress(e) {
        if (pressTimer) clearTimeout(pressTimer);
      }
    });
  </script>
</body>
</html>