<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pop Star Tour Math Escape â€” Year 9 | Aotearoa</title>
  <style>
    :root {
      --bg: #fdf2f8;
      --card: #ffffff;
      --accent: #ec4899;
      --accent-dark: #be185d;
      --success: #34d399;
      --danger: #f87171;
      --muted: #6b7280;
      --text: #1f2937;
      --highlight: #facc15;
      --max-width: 1000px;
      --pad: 1.5rem;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(180deg, #fdf2f8 0%, #fce7f3 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--pad);
      font-size: clamp(16px, 2.5vw, 18px);
    }
    .wrap { width: 100%; max-width: var(--max-width); margin: 0 auto; }

    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .brand { display: flex; gap: 0.8rem; align-items: center; }
    .logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .logo svg { width: 40px; height: 40px; fill: #ffffff; }
    h1 {
      font-size: clamp(1.5rem, 3vw, 1.8rem);
      margin: 0;
      color: var(--text);
    }
    p.lead {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.9rem, 2vw, 1rem);
    }

    .card {
      background: var(--card);
      padding: var(--pad);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .topbar {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .status { display: flex; gap: 0.8rem; align-items: center; }
    .chip {
      background: #fce7f3;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: clamp(0.85rem, 2vw, 0.95rem);
      color: var(--text);
      border: 1px solid var(--accent);
    }
    .timer { font-size: clamp(1rem, 2.5vw, 1.1rem); }

    .room { display: none; }
    .room.active { display: block; }

    .quiz {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 600px) { .quiz { grid-template-columns: 1fr 300px; } }
    @media (min-width: 900px) { .quiz { grid-template-columns: 1fr 350px; } }

    .puzzle {
      padding: 1.25rem;
      border-radius: 12px;
      background: #fff1f8;
    }

    /* Pop star pastel room backgrounds */
    #room1 {
      background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 50%, #fce7f3 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    #room2 {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    #room3 {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    #room4 {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fde68a 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--muted);
      font-size: clamp(0.85rem, 2vw, 0.95rem);
    }
    input[type=text], input[type=number] {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: #ffffff;
      color: var(--text);
      font-size: clamp(0.9rem, 2vw, 1rem);
    }
    button {
      cursor: pointer;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 0;
      background: var(--accent);
      color: #ffffff;
      font-weight: 600;
      font-size: clamp(0.9rem, 2vw, 1rem);
      transition: background 0.2s;
    }
    button:hover { background: var(--accent-dark); }
    button:active { transform: translateY(1px); }
    .muted { color: var(--muted); }

    .hint {
      background: #fce7f3;
      padding: 0.75rem;
      border-radius: 8px;
      margin-top: 0.75rem;
      font-size: clamp(0.85rem, 2vw, 0.9rem);
      border: 1px solid var(--accent);
    }
    .footer {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
    }

    .solved {
      background: #ecfdf5;
      border-left: 4px solid var(--success);
    }
    .locked {
      opacity: 0.85;
      background: #f3f4f6;
    }

    .clue {
      font-weight: 700;
      font-size: clamp(1.25rem, 2.5vw, 1.4rem);
      color: var(--text);
    }

    .progress {
      height: 14px;
      background: #fce7f3;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress > i {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #a855f7);
      width: 0%;
      transition: width 0.3s ease;
    }

    .small { font-size: clamp(0.8rem, 1.8vw, 0.85rem); }

    :focus {
      outline: 3px solid rgba(236, 72, 153, 0.3);
      outline-offset: 2px;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--pad);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 10;
    }
    .modal .card {
      max-width: 700px;
      text-align: center;
    }

    .debug {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      border: 1px solid #ccc;
      z-index: 100;
    }

    @media (max-width: 600px) {
      .logo { width: 48px; height: 48px; }
      header { gap: 0.75rem; }
      h1 { font-size: clamp(1.25rem, 2.5vw, 1.5rem); }
      .card { padding: 1rem; }
      button { padding: 0.6rem 0.8rem; }
      input[type=text], input[type=number] { padding: 0.6rem; }
    }
    @media (min-width: 600px) and (max-width: 900px) {
      .wrap { max-width: 90%; }
      .quiz { grid-template-columns: 1fr 280px; }
    }
  </style>
</head>
<body>
  <div class="debug" id="debugInfo">JS Loading...</div>
  
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" id="logo">
          <svg viewBox="0 0 24 24">
            <path d="M12 2a1 1 0 0 1 .894.553L20 14h-4v8H8v-8H4L11.106 2.553A1 1 0 0 1 12 2zm0 2.236L6.618 12H10v8h4v-8h3.382L12 4.236z"/>
          </svg>
        </div>
        <div>
          <h1>Pop Star Tour Math Escape â€” Year 9</h1>
          <p class="lead">Aotearoa NZ puzzles: algebra, fractions, geometry & patterns. Unlock the concert stages!</p>
        </div>
      </div>
      <div style="margin-left: auto; text-align: right;" class="small muted">Teacher: editable hints & answers</div>
    </header>

    <div class="card">
      <div class="topbar">
        <div class="status">
          <div class="chip">Stage <span id="roomIndex">1</span>/4</div>
          <div class="chip timer">ðŸŽ¤ <span id="timer">10:00</span></div>
          <div class="chip">Points: <span id="points">0</span></div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button id="pauseBtn" class="small">Pause</button>
          <button id="saveBtn" class="small">Save</button>
          <button id="resetBtn" class="small">Restart</button>
        </div>
      </div>

      <div class="progress" aria-hidden="true"><i id="progressFill"></i></div>

      <section id="room1" class="room active" aria-labelledby="r1">
        <h2 id="r1" class="clue">Stage 1 â€” Auckland Arena Pass</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>Solve for the stage pass code: <strong>2x + 3 = 11</strong>. What is <strong>x</strong>?</p>
            <label for="r1ans">Enter the value of x</label>
            <input id="r1ans" type="number" inputmode="numeric" placeholder="x" aria-label="Stage 1 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r1check">Submit</button>
              <button id="r1hint" class="small">Hint</button>
            </div>
            <div id="r1msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Isolate x by subtracting, then dividing.</p>
            <div class="hint small" id="r1hintbox" style="display: none;">Subtract 3 from both sides, then divide by 2.</div>
          </aside>
        </div>
      </section>

      <section id="room2" class="room" aria-labelledby="r2">
        <h2 id="r2" class="clue">Stage 2 â€” Wellington Stage Setup</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>Add fractions to set up the stage: <strong>1/4 + 1/3</strong>. Enter as a fraction (e.g., 2/3).</p>
            <label for="r2ans">Enter the fraction</label>
            <input id="r2ans" type="text" placeholder="a/b" aria-label="Stage 2 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r2check">Submit</button>
              <button id="r2hint" class="small">Hint</button>
            </div>
            <div id="r2msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Use a common denominator to add fractions.</p>
            <div class="hint small" id="r2hintbox" style="display: none;">The least common denominator for 4 and 3 is 12.</div>
          </aside>
        </div>
      </section>

      <section id="room3" class="room" aria-labelledby="r3">
        <h2 id="r3" class="clue">Stage 3 â€” Kiwi Pop Fest</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>The stage is a rectangle, 5m wide and 8m long. What is the perimeter in meters?</p>
            <label for="r3ans">Enter the perimeter in meters</label>
            <input id="r3ans" type="number" inputmode="numeric" aria-label="Stage 3 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r3check">Submit</button>
              <button id="r3hint" class="small">Hint</button>
            </div>
            <div id="r3msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Perimeter = 2 Ã— (width + length).</p>
            <div class="hint small" id="r3hintbox" style="display: none;">Add width and length, then multiply by 2.</div>
          </aside>
        </div>
      </section>

      <section id="room4" class="room" aria-labelledby="r4">
        <h2 id="r4" class="clue">Final Stage â€” Pop Star Finale</h2>
        <div class="quiz" style="margin-top: 1rem;">
          <div class="puzzle">
            <p>Find the next number in the sequence for the finale: <strong>2, 5, 8, 11, ?</strong>.</p>
            <label for="r4ans">Enter the next number</label>
            <input id="r4ans" type="number" inputmode="numeric" aria-label="Stage 4 answer" />
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
              <button id="r4check">Submit</button>
              <button id="r4hint" class="small">Hint</button>
            </div>
            <div id="r4msg" class="muted small" style="margin-top: 0.75rem;"></div>
          </div>
          <aside class="puzzle">
            <h3 class="small">Backstage Tips</h3>
            <p class="muted small">Look for a pattern in the sequence.</p>
            <div class="hint small" id="r4hintbox" style="display: none;">Each number increases by 3.</div>
          </aside>
        </div>
      </section>

      <div class="footer">
        <div class="muted small">Hints used: <span id="hintsUsed">0</span></div>
      </div>
    </div>
  </div>

  <template id="endModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="card">
        <h2>Rocked It! Tour Complete ðŸŽ‰</h2>
        <p class="muted">You scored <strong id="finalPoints"></strong> points and used <span id="finalHints"></span> hints.</p>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button id="closeEnd">Close</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    // Debug info
    const debugInfo = document.getElementById('debugInfo');
    function updateDebug(msg) {
      debugInfo.textContent = msg;
      console.log('DEBUG:', msg);
    }

    updateDebug('Script started');

    // Initialize immediately instead of waiting for DOMContentLoaded
    function initializeGame() {
      updateDebug('Initializing game...');

      const rooms = [
        { id: 'room1', check: checkR1, hintText: 'Subtract 3 from both sides, then divide by 2.', points: 20 },
        { id: 'room2', check: checkR2, hintText: 'The least common denominator for 4 and 3 is 12.', points: 15 },
        { id: 'room3', check: checkR3, hintText: 'Add width and length, then multiply by 2.', points: 15 },
        { id: 'room4', check: checkR4, hintText: 'Each number increases by 3.', points: 25 },
      ];

      const getCssVariable = (name) => {
        try {
          return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        } catch (e) {
          console.warn('Failed to get CSS variable:', name);
          return name === '--success' ? '#34d399' : '#f87171';
        }
      };
      
      const successColor = getCssVariable('--success');
      const dangerColor = getCssVariable('--danger');

      // Use memory storage instead of localStorage for better compatibility
      let gameState = {
        index: 0,
        points: 0,
        hints: 0,
        solved: new Array(rooms.length).fill(false),
        totalTime: 10 * 60
      };

      let timerInterval = null;
      let isPaused = false;

      // Get DOM elements
      const roomIndexEl = document.getElementById('roomIndex');
      const pointsEl = document.getElementById('points');
      const hintsEl = document.getElementById('hintsUsed');
      const timerEl = document.getElementById('timer');
      const progressFill = document.getElementById('progressFill');
      const pauseBtn = document.getElementById('pauseBtn');

      // Check if all elements exist
      const requiredElements = [roomIndexEl, pointsEl, hintsEl, timerEl, progressFill, pauseBtn];
      const missingElements = requiredElements.filter(el => !el);
      if (missingElements.length > 0) {
        updateDebug(`Missing elements: ${missingElements.length}`);
        return;
      }

      updateDebug('All elements found');

      // Initialize UI
      updateUI();
      startTimer();

      // Add event listeners with error handling
      function safeAddListener(element, event, handler, name) {
        if (element) {
          element.addEventListener(event, (e) => {
            try {
              updateDebug(`${name} clicked`);
              handler(e);
            } catch (error) {
              console.error(`Error in ${name} handler:`, error);
              updateDebug(`Error in ${name}`);
            }
          });
          updateDebug(`${name} listener added`);
        } else {
          updateDebug(`${name} element not found`);
        }
      }

      safeAddListener(pauseBtn, 'click', () => {
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
        if (isPaused) {
          clearInterval(timerInterval);
        } else {
          startTimer();
        }
      }, 'Pause button');

      safeAddListener(document.getElementById('saveBtn'), 'click', () => {
        alert('Game state saved in memory (localStorage not available in this environment).');
      }, 'Save button');

      safeAddListener(document.getElementById('resetBtn'), 'click', () => {
        if (confirm('Restart the tour? This will reset all progress.')) {
          gameState = {
            index: 0,
            points: 0,
            hints: 0,
            solved: new Array(rooms.length).fill(false),
            totalTime: 10 * 60
          };
          isPaused = false;
          updateUI();
          startTimer();
        }
      }, 'Reset button');

      // Add room-specific listeners
      rooms.forEach((r, i) => {
        const rid = r.id;
        const checkBtnId = rid.replace('room', 'r') + 'check';
        const hintBtnId = rid.replace('room', 'r') + 'hint';
        const hintBoxId = rid.replace('room', 'r') + 'hintbox';
        
        const checkBtn = document.getElementById(checkBtnId);
        const hintBtn = document.getElementById(hintBtnId);
        const hintBox = document.getElementById(hintBoxId);

        updateDebug(`Looking for ${checkBtnId}: ${!!checkBtn}`);
        updateDebug(`Looking for ${hintBtnId}: ${!!hintBtn}`);

        safeAddListener(checkBtn, 'click', () => r.check(), `${checkBtnId} check button`);
        
        safeAddListener(hintBtn, 'click', () => {
          if (hintBox && hintBox.style.display === 'none') {
            hintBox.style.display = 'block';
            gameState.hints++;
            hintsEl.textContent = gameState.hints;
          }
        }, `${hintBtnId} hint button`);
      });

      // Check functions
      function checkR1() {
        const input = document.getElementById('r1ans');
        const msg = document.getElementById('r1msg');
        if (!input || !msg) return;
        
        const val = Number(input.value.trim());
        if (!Number.isFinite(val)) {
          msg.textContent = 'Enter a number.';
          msg.style.color = dangerColor;
          return;
        }
        if (val === 4) {
          winRoom(0);
          msg.textContent = 'Correct â€” Auckland Arena unlocked!';
          msg.style.color = successColor;
        } else {
          msg.textContent = 'Try subtracting 3 from both sides, then divide by 2.';
          msg.style.color = dangerColor;
        }
      }

      function checkR2() {
        const input = document.getElementById('r2ans');
        const msg = document.getElementById('r2msg');
        if (!input || !msg) return;
        
        const val = input.value.trim().replace(/\s+/g, '');
        if (!val.match(/^\d+\/\d+$/)) {
          msg.textContent = 'Enter a fraction like a/b (e.g., 2/3).';
          msg.style.color = dangerColor;
          return;
        }
        if (val === '7/12') {
          winRoom(1);
          msg.textContent = 'Correct â€” Wellington Stage ready!';
          msg.style.color = successColor;
        } else {
          msg.textContent = 'Use a common denominator (12) to add 1/4 + 1/3.';
          msg.style.color = dangerColor;
        }
      }

      function checkR3() {
        const input = document.getElementById('r3ans');
        const msg = document.getElementById('r3msg');
        if (!input || !msg) return;
        
        const val = Number(input.value.trim());
        if (!Number.isFinite(val)) {
          msg.textContent = 'Enter a number.';
          msg.style.color = dangerColor;
          return;
        }
        if (val === 26) {
          winRoom(2);
          msg.textContent = 'Correct â€” Kiwi Pop Fest stage open!';
          msg.style.color = successColor;
        } else {
          msg.textContent = 'Use perimeter = 2 Ã— (width + length).';
          msg.style.color = dangerColor;
        }
      }

      function checkR4() {
        const input = document.getElementById('r4ans');
        const msg = document.getElementById('r4msg');
        if (!input || !msg) return;
        
        const val = Number(input.value.trim());
        if (!Number.isFinite(val)) {
          msg.textContent = 'Enter a number.';
          msg.style.color = dangerColor;
          return;
        }
        if (val === 14) {
          winRoom(3);
          msg.textContent = 'Correct â€” Pop Star Finale unlocked!';
          msg.style.color = successColor;
        } else {
          msg.textContent = 'Look for the pattern: each number increases by 3.';
          msg.style.color = dangerColor;
        }
      }

      function winRoom(i) {
        if (gameState.solved[i]) return;
        gameState.solved[i] = true;
        gameState.points += rooms[i].points;
        updateUI();

        const allSolved = gameState.solved.every(s => s);
        if (allSolved) {
          showEnd();
        } else {
          const next = findNextUnsolved(i + 1);
          if (next !== null) {
            gameState.index = next;
            updateUI();
          }
        }
      }

      function findNextUnsolved(start) {
        for (let i = start; i < rooms.length; i++) {
          if (!gameState.solved[i]) return i;
        }
        return null;
      }

      function updateUI() {
        rooms.forEach((r, i) => {
          const el = document.getElementById(r.id);
          if (el) {
            el.classList.toggle('active', i === gameState.index);
            el.classList.toggle('locked', !gameState.solved[i] && i !== gameState.index);
            el.classList.toggle('solved', gameState.solved[i]);
          }
        });
        
        if (roomIndexEl) roomIndexEl.textContent = Math.min(gameState.index + 1, rooms.length);
        if (pointsEl) pointsEl.textContent = gameState.points;
        if (hintsEl) hintsEl.textContent = gameState.hints;
        
        if (progressFill) {
          const solvedCount = gameState.solved.filter(Boolean).length;
          const pct = Math.round((solvedCount / rooms.length) * 100);
          progressFill.style.width = pct + '%';
        }
      }

      function startTimer() {
        if (isPaused || gameState.totalTime <= 0) return;
        updateTimerDisplay();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          gameState.totalTime--;
          if (gameState.totalTime <= 0) {
            clearInterval(timerInterval);
            onTimeUp();
          }
          updateTimerDisplay();
        }, 1000);
      }

      function updateTimerDisplay() {
        if (!timerEl) return;
        const mm = Math.floor(gameState.totalTime / 60);
        const ss = gameState.totalTime % 60;
        timerEl.textContent = `${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;
      }

      function onTimeUp() {
        isPaused = true;
        if (pauseBtn) pauseBtn.textContent = 'Resume';
        alert('Time\'s up! Click restart to try again.');
      }

      function showEnd() {
        clearInterval(timerInterval);
        isPaused = true;
        if (pauseBtn) pauseBtn.textContent = 'Resume';
        
        const existingModal = document.querySelector('.modal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="card">
            <h2>Rocked It! Tour Complete ðŸŽ‰</h2>
            <p class="muted">You scored <strong>${gameState.points} pts</strong> and used ${gameState.hints} hints.</p>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
              <button onclick="this.closest('.modal').remove()">Close</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Teacher quick reveal
      const logo = document.getElementById('logo');
      let pressTimer = null;
      
      if (logo) {
        logo.addEventListener('mousedown', startPress);
        logo.addEventListener('touchstart', startPress);
        logo.addEventListener('mouseup', cancelPress);
        logo.addEventListener('mouseleave', cancelPress);
        logo.addEventListener('touchend', cancelPress);
      }
      
      function startPress(e) {
        pressTimer = setTimeout(() => {
          const reveal = confirm('Teacher quick reveal? This will mark all stages solved.');
          if (reveal) {
            for (let i = 0; i < rooms.length; i++) gameState.solved[i] = true;
            gameState.points = rooms.reduce((s, r) => s + r.points, 0);
            updateUI();
            showEnd();
          }
        }, 900);
      }
      
      function cancelPress(e) {
        if (pressTimer) clearTimeout(pressTimer);
      }

      updateDebug('Game initialized successfully');
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
      initializeGame();
    }
  </script>
</body>
</html>